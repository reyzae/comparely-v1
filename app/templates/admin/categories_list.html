{% extends "admin/base_admin.html" %}

{% block title %}Categories{% endblock %}
{% block breadcrumb %}Categories Management{% endblock %}

{% block extra_css %}
<style>
    /* Bulk selection toolbar */
    .bulk-toolbar {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        display: none;
        align-items: center;
        gap: 1rem;
        animation: slideDown 0.3s ease;
    }

    .bulk-toolbar.show {
        display: flex;
    }

    .bulk-toolbar-text {
        flex: 1;
        font-weight: 600;
    }

    .bulk-toolbar-actions {
        display: flex;
        gap: 0.5rem;
    }

    /* Checkbox styling */
    .checkbox-cell {
        width: 40px;
        text-align: center;
    }

    input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    /* Row selection */
    tr.selected {
        background-color: #d1fae5 !important;
    }

    /* Device count badge */
    .device-count-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-radius: 8px;
        font-weight: 600;
        color: #1e40af;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">Category Management</h1>
    <p class="page-description">Kelola kategori perangkat</p>
</div>

<!-- Bulk Action Toolbar (Hidden by default) -->
<div class="bulk-toolbar" id="bulkToolbar">
    <div class="bulk-toolbar-text">
        <i class="fas fa-check-circle"></i>
        <span id="selectedCount">0</span> category(s) selected
    </div>
    <div class="bulk-toolbar-actions">
        <button type="button" class="btn btn-sm btn-secondary" onclick="clearSelection()">
            <i class="fas fa-times"></i> Clear
        </button>
        <button type="button" class="btn btn-sm btn-delete" onclick="bulkDelete()">
            <i class="fas fa-trash"></i> Delete Selected
        </button>
    </div>
</div>

<!-- Search Bar -->
<div class="card">
    <form method="GET" action="/admin/categories" style="display: flex; gap: 1rem; align-items: end;">
        <div class="form-group" style="flex: 1; margin-bottom: 0;">
            <label class="form-label">Search</label>
            <input type="text" name="search" placeholder="Cari category..." value="{{ search }}" class="form-input">
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i> Search
            </button>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <a href="/admin/categories/new" class="btn btn-success">
                <i class="fas fa-plus-circle"></i> Add New
            </a>
        </div>
    </form>
</div>

<!-- Categories Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">All Categories</h3>
    </div>

    <div class="table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th class="checkbox-cell">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                    </th>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Devices</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if category_stats %}
                {% for stat in category_stats %}
                <tr data-category-id="{{ stat.category.id }}">
                    <td class="checkbox-cell">
                        <input type="checkbox" class="category-checkbox" value="{{ stat.category.id }}"
                            data-device-count="{{ stat.device_count }}" onchange="updateBulkToolbar()">
                    </td>
                    <td>{{ stat.category.id }}</td>
                    <td><strong>{{ stat.category.name }}</strong></td>
                    <td>
                        <div class="device-count-badge">
                            <i class="fas fa-mobile-alt"></i>
                            <span>{{ stat.device_count }} devices</span>
                        </div>
                    </td>
                    <td class="actions">
                        <!-- Edit button -->
                        <a href="/admin/categories/{{ stat.category.id }}/edit" class="btn btn-sm btn-edit"
                            title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>

                        <!-- Delete button -->
                        <form method="POST" action="/admin/categories/{{ stat.category.id }}/delete"
                            style="display: inline;" data-category-name="{{ stat.category.name }}"
                            data-device-count="{{ stat.device_count }}" onsubmit="return confirmDelete(this)">
                            <button type="submit" class="btn btn-sm btn-delete" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="5" class="text-center" style="padding: 2rem;">
                        {% if search %}
                        <i class="fas fa-search" style="font-size: 2rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p>Tidak ada category yang cocok dengan "{{ search }}"</p>
                        {% else %}
                        <i class="fas fa-tags" style="font-size: 2rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p>Belum ada category. <a href="/admin/categories/new">Tambahkan category pertama</a></p>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
    <a href="?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}" class="page-link">
        <i class="fas fa-chevron-left"></i> Previous
    </a>
    {% endif %}

    <span class="page-info">Page {{ page }} of {{ total_pages }}</span>

    {% if page < total_pages %} <a href="?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}"
        class="page-link">
        Next <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Select/Deselect all checkboxes
    function toggleSelectAll(checkbox) {
        const checkboxes = document.querySelectorAll('.category-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = checkbox.checked;
            updateRowSelection(cb);
        });
        updateBulkToolbar();
    }

    // Update row selection visual
    function updateRowSelection(checkbox) {
        const row = checkbox.closest('tr');
        if (checkbox.checked) {
            row.classList.add('selected');
        } else {
            row.classList.remove('selected');
        }
    }

    // Update bulk toolbar visibility
    function updateBulkToolbar() {
        const checkboxes = document.querySelectorAll('.category-checkbox:checked');
        const toolbar = document.getElementById('bulkToolbar');
        const count = document.getElementById('selectedCount');

        count.textContent = checkboxes.length;

        if (checkboxes.length > 0) {
            toolbar.classList.add('show');
        } else {
            toolbar.classList.remove('show');
        }

        // Update row selection
        document.querySelectorAll('.category-checkbox').forEach(cb => {
            updateRowSelection(cb);
        });

        // Update select all checkbox
        const selectAll = document.getElementById('selectAll');
        const allCheckboxes = document.querySelectorAll('.category-checkbox');
        selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
    }

    // Clear selection
    function clearSelection() {
        document.querySelectorAll('.category-checkbox').forEach(cb => {
            cb.checked = false;
            updateRowSelection(cb);
        });
        document.getElementById('selectAll').checked = false;
        updateBulkToolbar();
    }

    // Bulk delete
    function bulkDelete() {
        const checkboxes = document.querySelectorAll('.category-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Pilih minimal 1 category untuk dihapus');
            return;
        }

        // Check if any selected category has devices
        let hasDevices = false;
        checkboxes.forEach(cb => {
            const deviceCount = parseInt(cb.getAttribute('data-device-count'));
            if (deviceCount > 0) {
                hasDevices = true;
            }
        });

        if (hasDevices) {
            alert('Tidak bisa menghapus category yang masih memiliki devices. Hapus devices terlebih dahulu atau pindahkan ke category lain.');
            return;
        }

        const count = checkboxes.length;
        if (!confirm(`Apakah Anda yakin ingin menghapus ${count} category(s)?`)) {
            return;
        }

        // Collect IDs
        const ids = Array.from(checkboxes).map(cb => cb.value);

        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/categories/bulk-delete';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'category_ids';
        input.value = ids.join(',');

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }

    // Confirm single delete
    function confirmDelete(form) {
        const categoryName = form.getAttribute('data-category-name');
        const deviceCount = parseInt(form.getAttribute('data-device-count'));

        if (deviceCount > 0) {
            alert(`Tidak bisa menghapus category "${categoryName}" karena masih memiliki ${deviceCount} devices.`);
            return false;
        }

        return confirm(`Apakah Anda yakin ingin menghapus category "${categoryName}"?`);
    }
</script>
{% endblock %}